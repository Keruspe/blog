<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="description" content="Keruspe's personal blog" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Keruspe's blag - Enabling TOTP 2 factor authentication on the laptop</title>
        <link href="http://fonts.googleapis.com/css?family=Arvo" rel="stylesheet" type="text/css" />
        <link href="http://fonts.googleapis.com/css?family=ABeeZee" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
        <link rel="alternate" type="application/rss+xml" title="Keruspe's blag" href="../rss.xml" />
        <link rel="shortcut icon" href="../favicon.png" />
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-36525806-1']);
            _gaq.push(['_setDomainName', 'imagination-land.org']);
            _gaq.push(['_setAllowLinker', true]);
            _gaq.push(['_trackPageview']);

            (function() {
                /* Google Analytics */
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                /* Google Plus */
                /*var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var ss = document.getElementsByTagName('script')[0]; ss.parentNode.insertBefore(po, ss);*/
                /* Disqus */
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://keruspe.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
    </head>
    <body>
        <header>
            <hgroup>
                <h1><a href="../">Keruspe's blag</a></h1>
                <h6>-</h6>
                <h2>Various free software hacking stuff</h2>
            </hgroup>
        </header>
        <nav>
            <menu>
                <a href="../"><img src="../images/home.png" alt="home" /> Home</a>
                <a href="../posts.html"><img src="../images/list.png" alt="list" /> All posts</a>
                <!-- <a href="http://marc-antoine.perennou.com">About me</a> -->
                <a href="http://github.com/Keruspe"><img class="bigger" src="../images/octocat.png" alt="octocat" /> My projects</a>
                <a href="http://www.clever-cloud.com/en/"><img class="bigger" src="../images/clever-cloud.png" alt="clever-cloud" /> My company</a>
                <a href="../rss.xml"><img src="../images/rss.png" alt="rss" /> RSS</a>
            </menu>
        </nav>
        <section>
            <article>
                <header>
                    <h1>Enabling TOTP 2 factor authentication on the laptop</h1>
                    <p class="by">by <em>Marc-Antoine Perennou</em> on <strong>May 17, 2016</strong></p>
                    <p>Tagged as: <a href="../tags/exherbo.html">exherbo</a>, <a href="../tags/security.html">security</a>, <a href="../tags/sysadmin.html">sysadmin</a>.</p>
                </header>

                <section>
<h2 id="totp-2fa-what-is-this-all-about">TOTP? 2FA? What is this all about?</h2>
<p>Usually, when you want to authenticate yourself, you decline your identity with either a user name or an email address, and you provide one factor of authentication, most likely being a password, a pass phrase or a PIN code.</p>
<p>That’s good, but that’s far from good enough. 2FA (two factor authentication) brings another factor of authentication as a requirement to authenticate yourself so that you now need two of those.</p>
<p>There are three kinds of factors:</p>
<ul>
<li>who you are (fingerprint, etc)</li>
<li>what you know (password, etc)</li>
<li>what you possess (a smart pone, a USB device, etc)</li>
</ul>
<p>The most popular 2FA method in the biggest popular web services (such as Google, Facebook, etc) is TOTP (Time-based One Time Password). The concept is fairly simple: you share a secret key with the service, and this secret key is used to generate a code, which varies every 30 seconds. There are a lot of applications to manage those but the most popular is certainly <a href="https://support.google.com/accounts/answer/1066447?hl=en">google-authenticator</a>. It’s simple to use: the service displays you a QR code when you enable 2FA, you flash it with the application, and then, in order to log in, you have to type both your password and the code displayed in the application.</p>
<h2 id="why-would-i-do-that-on-my-laptop">Why would I do that on my laptop</h2>
<p>My laptop is not only my personal computer. It also contains a lot of data that is Intellectual property of <a href="https://www.clever-cloud.com/">Clever Cloud</a>, the company I work for, and some keys to access lots of servers from projects I contribute to.</p>
<p>As a lot of people rely on me and the integrity and security of what I manage, my computer <em>needs</em> to be secure. My hard drive is obviously fully encrypted, but shit always can happen with shoulder surfing, or surveillance cameras, for example. A well organised malicious person could maybe get my password while I type it, so the password is not enough. Time to be paranoid and put an extra security measure.</p>
<h2 id="how-do-i-enable-2fa-on-my-laptop">How do I enable 2FA on my laptop?</h2>
<p>Google doesn’t only provide a nice client application, they also provide <a href="https://github.com/google/google-authenticator/tree/master/libpam">a PAM module</a>, that’s what we’re gonna use.</p>
<p>First you’ll need to install that. It should be available on most of distributions (for exherbo, the package is called <code>google-authenticator</code> in the <code>::keruspe</code> repository).</p>
<p>During the whole setup procedure, keeping a root shell around to fix stuff in case of an error is highly recommended.</p>
<p>First, run <code>google-authenticator</code> as your user. The agent will prompt you with several questions regarding configuration, and will print you a QR code once the setup is finished (if you have libqrencode installed, which you will if you’re using the exherbo package) that you can flash using the application. Do the same for the root user too.</p>
<p>By default, this will generate a <code>~/.google-authenticator</code> file belonging to the user. That’s not really acceptable as I don’t even want my user to be able to read that configuration (with the secret key in it). I thus created a <code>/etc/google-authenticator</code> directory, and I moved my two files in it, using the user name as file name. I thus have <code>/etc/google-authenticator/keruspe</code> and <code>/etc/google-authenticator/root</code>. Next important step is to make sure the rights and ownership are right.</p>
<pre><code>chown root:root /etc/google-authenticator/*
chmod 0400 /etc/google-authenticator/*</code></pre>
<p>Now, our files are read-only and belong to root, which is quite safer than a file in your home directory that even your web browser can read.</p>
<p>Last step: actually enable the feature and make it use those files. For that, you need to locate the pam configuration file responsible for system authentication. On exherbo, that is <code>/etc/pam.d/system-auth</code>. At the very beginning of that file, You just need to add this first line (or second if you want to enter your password before the verification code):</p>
<pre><code>auth        required    pam_google_authenticator.so user=root secret=/etc/google-authenticator/${USER}</code></pre>
<p>With that set, each time you try to login, use sudo, unlock your computer or authorise an admin action, you will be prompted for the TOTP code, and then for your password. The <code>user=root</code> part in the configuration will automatically make the authentication fail if the file in <code>/etc/google-authenticator</code> doesn’t belong to root.</p>
<p>Now let’s check that everything is working properly by logging as your user (<code>su - keruspe</code> for me) and as root (<code>su -</code>). If everything works fine, you’re done.</p>
<p>Voila, your computer is now more secure. The only way to bypass it is to edit the pam configuration file, which is not possible without your decryption key if your system is fully encrypted like mine.</p>
                </section>
            </article>

            <section class="social">
                <!--<div class="g-plusone" data-align="right"></div>-->
                <div id="disqus_thread"></div>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </section>

        </section>
        <footer>
            <p>
                This  work is licensed under a
                <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
                    Creative Commons Attribution-ShareAlike 3.0 Unported License
                    <img id="cc-icon" alt="Creative Commons License" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png">
                </a>.
            </p>
        </footer>
    </body>
</html>
