<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="description" content="Keruspe's personal blog" />
        <title>Keruspe's blag - Facron - fanotify cron system</title>
        <link href="http://fonts.googleapis.com/css?family=Arvo" rel="stylesheet" type="text/css" />
        <link href="http://fonts.googleapis.com/css?family=ABeeZee" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="alternate" type="application/rss+xml" title="Keruspe's blag" href="../rss.xml" />
        <link rel="shortcut icon" href="../favicon.png" />
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-36525806-1']);
            _gaq.push(['_setDomainName', 'imagination-land.org']);
            _gaq.push(['_setAllowLinker', true]);
            _gaq.push(['_trackPageview']);

            (function() {
                /* Google Analytics */
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                /* Google Plus */
                /*var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var ss = document.getElementsByTagName('script')[0]; ss.parentNode.insertBefore(po, ss);*/
                /* Disqus */
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://keruspe.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
    </head>
    <body>
        <header>
            <hgroup>
                <h1><a href="../">Keruspe's blag</a></h1>
                <h6>-</h6>
                <h2>Various free software hacking stuff</h2>
            </hgroup>
        </header>
        <nav>
            <menu>
                <a href="../"><img src="../images/home.png" alt="home" /> Home</a>
                <a href="../posts.html"><img src="../images/list.png" alt="list" /> All posts</a>
                <!-- <a href="http://marc-antoine.perennou.com">About me</a> -->
                <a href="http://github.com/Keruspe"><img class="bigger" src="../images/octocat.png" alt="octocat" /> My projects</a>
                <a href="http://www.clever-cloud.com"><img class="bigger" src="../images/clever-cloud.png" alt="clever-cloud" /> My company</a>
                <a href="../rss.xml"><img src="../images/rss.png" alt="rss" /> RSS</a>
            </menu>
        </nav>
        <section>
            <article>
                <header>
                    <h1>Facron - fanotify cron system</h1>
                    <p>by <em>Marc-Antoine Perennou</em> on <strong>December  4, 2012</strong></p>
                    <p>Tagged as: <a href="../tags/facron.html">facron</a>, <a href="../tags/fanotify.html">fanotify</a>, <a href="../tags/cron.html">cron</a>, <a href="../tags/sysadmin.html">sysadmin</a>.</p>
                </header>

                <section>
<p>It’s available on github: <a href="https://github.com/Keruspe/facron">https://github.com/Keruspe/facron</a></p>
<h2 id="the-filesystem-cron-principle">The filesystem cron principle</h2>
<p>At <a href="http://www.clever-cloud.com">Clever Cloud</a>, we often have to manage stuff based on filesystem events. In order to react dynamically, we will sometimes have to reload some specific configurations when the config file has changed, or we’ll want to wrap some files which just appeared to grab them in the global flow.</p>
<p>Filesystem crons allow you to do this kind of things. What you have to do is specify the files you want to monitor with the events you want to react to and the action you want to proceed when those events occur.</p>
<h2 id="incron">Incron</h2>
<p><a href="http://inotify.aiken.cz/?section=incron&amp;page=about&amp;lang=en">Incron</a> is the filesystem cron we’ve been using so far. It’s based on the <a href="http://en.wikipedia.org/wiki/Inotify">inotify</a> linux system. Inotify was the replacement to dnotify which has been deprecated for quite a long time now. Thanks to inotify, incron watches for filesystem changes and act accordingly, given the configuration file you provide.</p>
<p>Incron does not support <a href="http://fuse.sourceforge.net">FUSE</a> which is used by several filesystems, since inotify doesn’t support it either.</p>
<p>We experienced quite a few instabilities with incron which was not as reliable as we expected, ending up with ugly bash hacks to do the job correctly. That’s why I decided we needed our own solution.</p>
<h2 id="facron">Facron</h2>
<p><a href="https://github.com/Keruspe/facron">Facron</a> is my vision of the filesystem cron problematic. It is based on the “new” <a href="http://lwn.net/Articles/339253">fanotify</a> <a href="http://en.wikipedia.org/wiki/Application_binary_interface">ABI</a> which is more reliable and have better performances than the now deprecated inotify one. I started to write it two days ago, it’s at a stage where it’s usable. It’s not yet perfect and I want to improve it a little but you already can try it.</p>
<p>The configuration file (<code>/etc/facron.conf</code>) looks like:</p>
<pre><code>/path/to/a/file FAN_MODIFY|FAN_EVENT_ON_CHILD /path/to/script fromFacron $$</code></pre>
<p>The first element is the file or directory to watch (of course multiple lines are supported), the second one corresponds to all fanotify events that you want to follow, and then your script or application (full path is recommended) + arguments. <code>$$</code> is a special token which will be replaced by the full path of the file which has emitted the event.</p>
<p>The available fanotify events are:</p>
<ul>
<li><code>FAN_ACCESS</code></li>
<li><code>FAN_MODIFY</code></li>
<li><code>FAN_CLOSE_WRITE</code></li>
<li><code>FAN_CLOSE_NOWRITE</code></li>
<li><code>FAN_OPEN</code></li>
<li><code>FAN_Q_OVERFLOW</code></li>
<li><code>FAN_OPEN_PERM</code></li>
<li><code>FAN_ACCESS_PERM</code></li>
<li><code>FAN_ONDIR</code></li>
<li><code>FAN_EVENT_ON_CHILD</code></li>
<li><code>FAN_CLOSE</code></li>
<li><code>FAN_ALL_EVENTS</code></li>
<li><code>FAN_ALL_PERM_EVENTS</code></li>
<li><code>FAN_ALL_OUTGOING_EVENTS</code></li>
</ul>
<p>Two more special tokens will appear: <code>$@</code> which will contain the dirname of the file, and <code>$#</code> which will contain its basename.</p>
<p>A systemd service file and a release tarball will be provided soon.</p>
<p>You can reload the configuration at any time by sending a <code>SIGUSR1</code> to facron:</p>
<pre><code>kill -USR1 $(pidof facron)</code></pre>
                </section>
            </article>

            <section class="social">
                <!--<div class="g-plusone" data-align="right"></div>-->
                <div id="disqus_thread"></div>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </section>

        </section>
        <footer>
            <p>
                This  work is licensed under a
                <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
                    Creative Commons Attribution-ShareAlike 3.0 Unported License
                    <img id="cc-icon" alt="Creative Commons License" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png">
                </a>.
            </p>
        </footer>
    </body>
</html>
